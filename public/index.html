<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Car Rental Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    /* Hide all tab panes by default */
    .tab-pane { display: none; }
    /* Only the active tab pane is shown */
    .tab-pane.active { display: block; }
    /* Optional margin for progress bars */
    .progress { margin-bottom: 10px; }
    /* Spanner button style override */
    .spanner-btn { border: none; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mt-4 text-center">Car Rental Management System</h1>
  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs" id="appTabs">
    <li class="nav-item">
      <a class="nav-link active" data-target="#dashboardTab" href="#">Dashboard</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-target="#carsTab" href="#">Cars</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-target="#rentalsTab" href="#">Rentals</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-target="#dataTab" href="#">Data</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-target="#marketingTab" href="#">Marketing</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-target="#financesTab" href="#">Finances</a>
    </li>
  </ul>
  
  <!-- Tab Content -->
  <div class="tab-content mt-4">
    <!-- Dashboard Tab -->
    <div id="dashboardTab" class="tab-pane active">
      <h3>Dashboard</h3>
      <div id="dashboardContent">
        <!-- Available cars and active rentals will load here -->
      </div>
    </div>
    
    <!-- Cars Tab -->
    <div id="carsTab" class="tab-pane">
      <h3>Add Car</h3>
      <form id="addCarForm">
        <div class="form-row">
          <div class="form-group col-md-3">
            <input type="text" class="form-control" name="make" placeholder="Make" required>
          </div>
          <div class="form-group col-md-3">
            <input type="text" class="form-control" name="model" placeholder="Model" required>
          </div>
          <div class="form-group col-md-2">
            <input type="number" class="form-control" name="year" placeholder="Year" required>
          </div>
          <div class="form-group col-md-2">
            <input type="number" class="form-control" name="mileage" placeholder="Mileage" required>
          </div>
          <div class="form-group col-md-2">
            <!-- Service Due is still entered here -->
            <input type="date" class="form-control" name="serviceDue" placeholder="Service Due" required>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Car</button>
      </form>
      <hr>
      <h4>All Cars</h4>
      <table class="table table-bordered" id="carsTable">
        <thead>
          <tr>
            <th>Make</th>
            <th>Model</th>
            <th>Year</th>
            <th>Mileage</th>
            <th>Service Due</th>
            <th>Reminders</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Rentals Tab -->
    <div id="rentalsTab" class="tab-pane">
      <h3>Add Rental</h3>
      <form id="addRentalForm">
        <div class="form-row">
          <div class="form-group col-md-3">
            <select class="form-control" name="car" required>
              <option value="">Select Car</option>
            </select>
          </div>
          <div class="form-group col-md-3">
            <input type="date" class="form-control" name="rentalDate" required>
          </div>
          <div class="form-group col-md-3">
            <input type="date" class="form-control" name="returnDate" required>
          </div>
          <div class="form-group col-md-3">
            <input type="number" step="0.01" class="form-control" name="rentalFee" placeholder="Rental Fee" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <input type="text" class="form-control" name="customerName" placeholder="Customer Name" required>
          </div>
          <div class="form-group col-md-4">
            <input type="text" class="form-control" name="customerReg" placeholder="Customer Reg">
          </div>
          <div class="form-group col-md-4">
            <input type="email" class="form-control" name="customerEmail" placeholder="Customer Email">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <input type="text" class="form-control" name="customerNumber" placeholder="Customer Number">
          </div>
          <div class="form-group col-md-4">
            <select class="form-control" name="rentalType" required>
              <option value="">Select Rental Type</option>
              <option value="Rental">Rental</option>
              <option value="Reservation">Reservation</option>
            </select>
          </div>
          <div class="form-group col-md-4">
            <input type="text" class="form-control" name="note" placeholder="Note">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Rental</button>
      </form>
      <hr>
      <h4>All Rentals</h4>
      <table class="table table-bordered" id="rentalsTable">
        <thead>
          <tr>
            <th>Status</th>
            <th>Car</th>
            <th>Rental Date</th>
            <th>Return Date</th>
            <th>Rental Fee</th>
            <th>Customer</th>
            <th>Type</th>
            <th>Note</th>
            <th>Rating</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Data Tab -->
    <div id="dataTab" class="tab-pane">
      <h3>Rental Logs</h3>
      <table class="table table-bordered" id="logsTable">
        <thead>
          <tr>
            <th>From Date</th>
            <th>To Date</th>
            <th>Name</th>
            <th>Reg</th>
            <th>Type</th>
            <th>Rating</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Marketing Tab -->
    <div id="marketingTab" class="tab-pane">
      <h3>Marketing (Good Customers)</h3>
      <div id="marketingCustomers">
        <!-- List of good customers will appear here -->
      </div>
      <hr>
      <h4>Add Marketing Message</h4>
      <form id="addMarketingForm">
        <div class="form-group">
          <textarea class="form-control" name="content" rows="3" placeholder="Write your marketing message here..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Add Message</button>
      </form>
      <hr>
      <h4>Marketing Messages</h4>
      <ul class="list-group" id="marketingList"></ul>
    </div>
    
    <!-- Finances Tab -->
    <div id="financesTab" class="tab-pane">
      <div class="d-flex justify-content-between align-items-center">
        <h3>Finances</h3>
        <div>
          <span><strong>Account Balance: $<span id="accountBalance">0.00</span></strong></span>
          <button class="btn btn-sm btn-outline-secondary" id="updateAccountBtn">Update</button>
        </div>
      </div>
      <!-- (Finances content unchanged) -->
      <div class="mb-3">
        <div class="form-row">
          <div class="form-group col-md-3">
            <label for="fromDate">From:</label>
            <input type="date" class="form-control" id="fromDate">
          </div>
          <div class="form-group col-md-3">
            <label for="toDate">To:</label>
            <input type="date" class="form-control" id="toDate">
          </div>
          <div class="form-group col-md-3 align-self-end">
            <button class="btn btn-secondary" id="loadFinancesBtn">Load Finances</button>
          </div>
        </div>
      </div>
      <hr>
      <h4>Earnings (From Rentals)</h4>
      <table class="table table-bordered" id="earningsTable">
        <thead>
          <tr>
            <th>Car</th>
            <th>Customer</th>
            <th>Rental Period</th>
            <th>Rental Fee</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <hr>
      <h4>Expenses</h4>
      <table class="table table-bordered" id="expensesTable">
        <thead>
          <tr>
            <th>Car</th>
            <th>Customer</th>
            <th>Amount</th>
            <th>Description</th>
            <th>Note</th>
            <th>Receipt Image</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <hr>
      <h4>Add Expense</h4>
      <form id="addFinanceForm">
        <div class="form-row">
          <div class="form-group col-md-2">
            <select class="form-control" name="type" required>
              <option value="expense">Expense</option>
            </select>
          </div>
          <div class="form-group col-md-3">
            <input type="text" class="form-control" name="customerName" placeholder="Customer Name">
          </div>
          <div class="form-group col-md-2">
            <input type="number" step="0.01" class="form-control" name="amount" placeholder="Amount" required>
          </div>
          <div class="form-group col-md-2">
            <input type="text" class="form-control" name="description" placeholder="Description" required>
          </div>
          <div class="form-group col-md-3">
            <input type="text" class="form-control" name="note" placeholder="Expense Note (optional)">
          </div>
        </div>
        <div class="form-group">
          <input type="text" class="form-control" name="receiptImage" placeholder="Receipt Image URL (optional)">
        </div>
        <div class="form-group">
          <select class="form-control" name="car">
            <option value="">Select Car (optional)</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Add Expense</button>
      </form>
      <hr>
      <h4>Recent Transactions (Last 24 Hours)</h4>
      <table class="table table-bordered" id="recentTransactionsTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Car</th>
            <th>Customer</th>
            <th>Amount</th>
            <th>Description</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal for Early Return / Completing a Rental -->
<div class="modal fade" id="earlyReturnModal" tabindex="-1" role="dialog" aria-labelledby="earlyReturnModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="earlyReturnForm">
        <div class="modal-header">
          <h5 class="modal-title" id="earlyReturnModalLabel">Early Return / Complete Rental</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="rentalId" id="earlyReturnRentalId">
          <div class="form-group">
            <label for="earlyReturnRating">Customer Rating</label>
            <select class="form-control" name="rating" id="earlyReturnRating" required>
              <option value="">Select Rating</option>
              <option value="Good">Good</option>
              <option value="Bad">Bad</option>
            </select>
          </div>
          <div class="form-group">
            <label for="earlyReturnComment">Comment</label>
            <textarea class="form-control" name="comment" id="earlyReturnComment" rows="2" required></textarea>
          </div>
          <div class="form-group">
            <label for="earlyReturnReason">Reason for Ending Rental</label>
            <textarea class="form-control" name="reason" id="earlyReturnReason" rows="2" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit End Rental</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal for Updating Reminders on a Car -->
<div class="modal fade" id="reminderModal" tabindex="-1" role="dialog" aria-labelledby="reminderModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="reminderForm">
        <div class="modal-header">
          <h5 class="modal-title" id="reminderModalLabel">Update Reminders</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="carId" id="reminderCarId">
          <div class="form-group">
            <label for="reminderServiceDue">Service Due Date</label>
            <input type="date" class="form-control" name="serviceDue" id="reminderServiceDue">
          </div>
          <div class="form-group">
            <label for="reminderTireChangeDate">Tire Change Date</label>
            <input type="date" class="form-control" name="tireChangeDate" id="reminderTireChangeDate">
          </div>
          <div class="form-group">
            <label for="reminderRegistrationDate">Registration Date</label>
            <input type="date" class="form-control" name="registrationDate" id="reminderRegistrationDate">
          </div>
          <div class="form-group">
            <label for="reminderTaxDate">Tax Date</label>
            <input type="date" class="form-control" name="taxDate" id="reminderTaxDate">
          </div>
          <!-- New custom reminder row -->
          <div class="form-group">
            <label for="reminderCustomMessage">Custom Reminder Message</label>
            <input type="text" class="form-control" name="customReminderMessage" id="reminderCustomMessage" placeholder="Enter custom reminder">
          </div>
          <div class="form-group">
            <label for="reminderCustomDate">Custom Reminder Date</label>
            <input type="date" class="form-control" name="customReminderDate" id="reminderCustomDate">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Reminders</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- jQuery, Popper.js, and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
  // ---------------------------
  // Utility Functions
  // ---------------------------
  
  // Compute the color class based on the soonest upcoming reminder.
  function getReminderColor(car) {
    const now = new Date();
    let minDiff = Infinity;
    const reminderDates = [];
    if (car.serviceDue) reminderDates.push(new Date(car.serviceDue));
    if (car.tireChangeDate) reminderDates.push(new Date(car.tireChangeDate));
    if (car.registrationDate) reminderDates.push(new Date(car.registrationDate));
    if (car.taxDate) reminderDates.push(new Date(car.taxDate));
    if (car.customReminder && car.customReminder.date) {
      reminderDates.push(new Date(car.customReminder.date));
    }
    reminderDates.forEach(d => {
      if (d > now) {
        const diffDays = (d - now) / (1000 * 60 * 60 * 24);
        if (diffDays < minDiff) {
          minDiff = diffDays;
        }
      }
    });
    if (minDiff === Infinity) {
      return "bg-success"; // No upcoming reminders set
    } else if (minDiff <= 7) {
      return "bg-danger";
    } else if (minDiff <= 30) {
      return "bg-warning";
    } else {
      return "bg-success";
    }
  }
  
  // Load cars and update dropdowns and the cars table with the spanner button.
  function loadCars() {
    $.get('/api/cars', function(data) {
      let rows = '';
      let options = '<option value="">Select Car</option>';
      data.forEach(function(car) {
        // Determine the spanner button color based on all reminder dates.
        const colorClass = getReminderColor(car);
        rows += `<tr>
          <td>${car.make}</td>
          <td>${car.model}</td>
          <td>${car.year}</td>
          <td>${car.mileage}</td>
          <td>${car.serviceDue ? new Date(car.serviceDue).toLocaleDateString() : ''}</td>
          <td>
            <button class="btn btn-sm spanner-btn ${colorClass} text-white" data-id="${car._id}" data-car='${JSON.stringify(car)}'>
              🔧
            </button>
          </td>
        </tr>`;
        options += `<option value="${car._id}">${car.make} ${car.model} (${car.year})</option>`;
      });
      $('#carsTable tbody').html(rows);
      // Update all car dropdowns (in rentals and finances)
      $('select[name="car"]').html(options);
    }).fail(function() {
      alert('Failed to load cars.');
    });
  }
  
  // Load active rentals for Dashboard with progress bars and End Early buttons.
  function loadActiveRentals() {
    $.get('/api/rentals/active', function(rentals) {
      let rentalHtml = '<h4 class="mt-4">Active Rentals</h4>';
      if (rentals.length === 0) {
        rentalHtml += '<p>No active rentals.</p>';
      } else {
        rentalHtml += '<div class="list-group">';
        const now = new Date().getTime();
        rentals.forEach(function(rental) {
          const rentalStart = new Date(rental.rentalDate).getTime();
          const rentalEnd = new Date(rental.returnDate).getTime();
          const progress = Math.min(100, Math.round(((now - rentalStart) / (rentalEnd - rentalStart)) * 100));
          const ended = now >= rentalEnd;
          rentalHtml += `<div class="list-group-item">
            <h5>${rental.car ? rental.car.make + ' ' + rental.car.model + ' (' + rental.car.year + ')' : 'N/A'}</h5>
            <p>Rental Period: ${new Date(rental.rentalDate).toLocaleDateString()} - ${new Date(rental.returnDate).toLocaleDateString()}</p>
            <div class="progress mb-2">
              <div class="progress-bar ${ended ? 'bg-danger' : 'bg-success'}" role="progressbar" style="width: ${progress}%;" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                ${progress}%
              </div>
            </div>
            <button class="btn btn-sm btn-warning end-early-btn" data-id="${rental._id}" ${ended ? 'disabled' : ''}>End Early</button>
            ${ended ? '<span class="badge badge-danger ml-2">Rental Ended</span>' : ''}
          </div>`;
        });
        rentalHtml += '</div>';
      }
      $('#dashboardContent').append(rentalHtml);
    }).fail(function() {
      alert('Failed to load active rentals.');
    });
  }
  
  // Load available cars (for Dashboard's available cars section)
  function loadAvailableCars() {
    $.get('/api/cars', function(cars) {
      let availableHtml = '<h4>Available Cars</h4>';
      if (cars.length === 0) {
        availableHtml += '<p>No cars available.</p>';
      } else {
        availableHtml += '<ul class="list-group">';
        cars.forEach(function(car) {
          availableHtml += `<li class="list-group-item">${car.make} ${car.model} (${car.year})</li>`;
        });
        availableHtml += '</ul>';
      }
      $('#dashboardContent').html(availableHtml);
    }).fail(function() {
      $('#dashboardContent').html('<p class="text-danger">Failed to load available cars.</p>');
    });
  }
  
  // Load Dashboard (available cars and active rentals)
  function loadDashboard() {
    loadAvailableCars();
    loadActiveRentals();
  }
  
  // Load all rentals for the Rentals tab table.
  function loadRentals() {
    $.get('/api/rentals', function(rentals) {
      let rows = '';
      rentals.forEach(function(rental) {
        const status = rental.active ? 'Rented' : 'Available';
        const carInfo = rental.car 
          ? `${rental.car.make} ${rental.car.model} (${rental.car.year})`
          : 'N/A';
        rows += `<tr>
          <td>${status}</td>
          <td>${carInfo}</td>
          <td>${new Date(rental.rentalDate).toLocaleDateString()}</td>
          <td>${new Date(rental.returnDate).toLocaleDateString()}</td>
          <td>${rental.rentalFee}</td>
          <td>${rental.customerName}</td>
          <td>${rental.rentalType}</td>
          <td>${rental.note || ''}</td>
          <td>${rental.rating || ''}</td>
          <td>`;
        if (rental.active) {
          rows += `<button class="btn btn-sm btn-warning end-early-btn" data-id="${rental._id}">End Early</button>`;
        }
        rows += `</td>
        </tr>`;
      });
      $('#rentalsTable tbody').html(rows);
    }).fail(function() {
      alert('Failed to load rentals.');
    });
  }
  
  // Load logs for Data tab – one row per rental with the required columns.
  function loadData() {
    $.get('/api/rentals', function(rentals) {
      let rows = '';
      rentals.forEach(function(rental) {
        rows += `<tr>
          <td>${new Date(rental.rentalDate).toLocaleDateString()}</td>
          <td>${new Date(rental.returnDate).toLocaleDateString()}</td>
          <td>${rental.customerName}</td>
          <td>${rental.customerReg || ''}</td>
          <td>${rental.rentalType}</td>
          <td>${rental.rating || ''}</td>
          <td>${rental.rentalFee}</td>
        </tr>`;
      });
      $('#logsTable tbody').html(rows);
    }).fail(function() {
      alert('Failed to load rental logs.');
    });
  }
  
  // ---------------------------
  // Event Handlers
  // ---------------------------
  $(document).ready(function(){
    // Tab switching logic
    $('.nav-link').click(function(e){
      e.preventDefault();
      const target = $(this).data('target');
      $('.nav-link').removeClass('active');
      $(this).addClass('active');
      $('.tab-pane').removeClass('active');
      $(target).addClass('active');
      
      if(target === "#dashboardTab"){
        loadDashboard();
      } else if(target === "#carsTab"){
        loadCars(); // refresh cars table and dropdowns
      } else if(target === "#rentalsTab"){
        loadCars();    // refresh car dropdown for the rental form
        loadRentals();
      } else if(target === "#dataTab"){
        loadData();
      }
    });
    
    // Handle Add Car form submission
    $('#addCarForm').submit(function(e){
      e.preventDefault();
      const formData = $(this).serialize();
      $.post('/api/cars', formData, function(response) {
        alert('Car added successfully!');
        $('#addCarForm')[0].reset();
        loadCars();       // refresh Cars tab and update dropdowns
        loadDashboard();  // refresh Dashboard available cars
      }).fail(function() {
        alert('Error adding car.');
      });
    });
    
    // Handle Add Rental form submission
    $('#addRentalForm').submit(function(e) {
      e.preventDefault();
      const formData = $(this).serialize();
      $.post('/api/rentals', formData, function(response) {
        alert('Rental added successfully!');
        $('#addRentalForm')[0].reset();
        loadActiveRentals(); // refresh active rentals on Dashboard
        loadRentals();       // refresh All Rentals table
      }).fail(function() {
        alert('Error adding rental.');
      });
    });
    
    // Delegate click event for the "End Early" button in active rentals or rentals table
    $(document).on('click', '.end-early-btn', function(){
      const rentalId = $(this).data('id');
      $('#earlyReturnRentalId').val(rentalId);
      $('#earlyReturnModalLabel').text('End Rental Early');
      $('#earlyReturnModal').modal('show');
    });
    
    // Delegate click event for the spanner icon on a car row (to update reminders)
    $(document).on('click', '.spanner-btn', function(){
      const carId = $(this).data('id');
      const car = JSON.parse($(this).attr('data-car'));
      $('#reminderCarId').val(carId);
      // Pre-populate fixed reminder inputs
      $('#reminderServiceDue').val(car.serviceDue ? new Date(car.serviceDue).toISOString().split('T')[0] : '');
      $('#reminderTireChangeDate').val(car.tireChangeDate ? new Date(car.tireChangeDate).toISOString().split('T')[0] : '');
      $('#reminderRegistrationDate').val(car.registrationDate ? new Date(car.registrationDate).toISOString().split('T')[0] : '');
      $('#reminderTaxDate').val(car.taxDate ? new Date(car.taxDate).toISOString().split('T')[0] : '');
      // Pre-populate custom reminder inputs
      $('#reminderCustomMessage').val(car.customReminder ? car.customReminder.message : '');
      $('#reminderCustomDate').val(car.customReminder && car.customReminder.date ? new Date(car.customReminder.date).toISOString().split('T')[0] : '');
      $('#reminderModal').modal('show');
    });
    
    // Handle Reminder form submission
    $('#reminderForm').submit(function(e) {
      e.preventDefault();
      const carId = $('#reminderCarId').val();
      const formData = $(this).serialize();
      $.post('/api/cars/' + carId + '/reminders', formData, function(response) {
        alert('Reminders updated successfully!');
        $('#reminderModal').modal('hide');
        loadCars(); // reload cars table to update spanner icon color
      }).fail(function() {
        alert('Error updating reminders.');
      });
    });
    
    // Handle Early Return / Complete Rental modal submission
    $('#earlyReturnForm').submit(function(e) {
      e.preventDefault();
      const rentalId = $('#earlyReturnRentalId').val();
      const formData = $(this).serialize();
      $.post('/api/rentals/' + rentalId + '/end', formData, function(response) {
        alert('Rental completed successfully.');
        $('#earlyReturnModal').modal('hide');
        loadActiveRentals();
        loadRentals();
      }).fail(function() {
        alert('Failed to complete rental.');
      });
    });
    
    // Initial load of Dashboard on page load
    loadDashboard();
  });
</script>
</body>
</html>
